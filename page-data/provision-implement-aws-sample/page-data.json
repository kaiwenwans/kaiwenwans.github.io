{"componentChunkName":"component---src-templates-blog-post-js","path":"/provision-implement-aws-sample/","result":{"data":{"site":{"siteMetadata":{"title":"kevin wang's blog"}},"markdownRemark":{"id":"cbd496d8-41c6-596f-bf5e-f5be1312d94c","excerpt":"在上一篇提到了 Provision 的概念， 這一篇會再提到 AWS 上實作 Provision 的一些細節與思路。 定義初始化腳本 在 Provision 的時候， 機器需要做一系列的指令來完成準備。 通常會透過開機腳本來達成。   開機腳本 在 Launch Templete 中有 User Data…","html":"<p>在<a href=\"../a-way-to-rolling-update-your-service-on-cloud\">上一篇</a>提到了 Provision 的概念，<br>\n這一篇會再提到 AWS 上實作 Provision 的一些細節與思路。</p>\n<h2>定義初始化腳本</h2>\n<p>在 Provision 的時候，<br>\n機器需要做一系列的指令來完成準備。<br>\n通常會透過開機腳本來達成。  </p>\n<h2>開機腳本</h2>\n<p>在 Launch Templete 中有 <strong>User Data</strong> 的設定，<br>\n如果機器是指定依照 Launch Templete 開機，<br>\n就可以使用 User Data 內的指令達成執行開機腳本的目的。<br>\n我們可以將開機腳本放在 S3 上，<br>\n在機器執行 User Data 內的指令時，<br>\n從 S3 取得腳本執行指令。<br>\n可以參考如下的實作</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash -xe</span>\naws s3 <span class=\"token function\">cp</span> s3://<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>s3 bucket name<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>/main.sh main.sh --region <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>region<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n<span class=\"token function\">bash</span> main.sh</code></pre></div>\n<h2>共用 main.sh</h2>\n<p>不同的服務可能會有不同的部屬方式。<br>\n但大致上都會有一些相同的流程，<br>\n比方像是安裝服務，<br>\n發送服務完成部屬的訊息等。<br>\n大概會像是這樣</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">安裝共用服務(e.g: filebeat) ...\n\n安裝線上服務 ...\n\n測試服務是否安裝完成 ...\n\n發送服務準備結果通知  ...</code></pre></div>\n<p>以上面的例子，<br>\n服務準備相關的動作可能會不同，<br>\n但安裝共用服務就會是相同的。<br>\n我們可以將 script 拆成 <strong>main</strong> 以及 <strong>install</strong> 兩個 Script，<br>\ninstall 實作各自服務的安裝，<br>\n並在 main 內執行各自的 install，<br>\n完成不同的部屬動作。  </p>\n<h2>從共用 main 中取得不同的 install script</h2>\n<p>要在共用的 main 中取得不同服務的 install script 的方向是</p>\n<ul>\n<li>\n<p>在 EC2 Tag 標示該服務的相關資訊</p>\n<ul>\n<li>可以在 Launch templete 或是 AutoScaling Group 設定是否要 <strong>Tag new instance</strong></li>\n</ul>\n</li>\n<li>在 main 中取得 Tag</li>\n<li>取得服務對應的 install script</li>\n</ul>\n<p>在 <a href=\"https://docs.aws.amazon.com/zh_tw/AWSEC2/latest/UserGuide/instancedata-data-retrieval.html\">AWS 的文件</a>有提到，<br>\n在 AWS 上的機器內可以透過</p>\n<blockquote>\n<p>curl <a href=\"http://169.254.169.254/latest/dynamic/instance-identity/document\">http://169.254.169.254/latest/dynamic/instance-identity/document</a></p>\n</blockquote>\n<p>取得類似以下的回傳</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"accountId\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"zzz\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"architecture\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"x86_64\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"availabilityZone\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"ap-northeast-1d\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"billingProducts\"</span> <span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"devpayProductCodes\"</span> <span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"marketplaceProductCodes\"</span> <span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"imageId\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"ami-xxx\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"instanceId\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"i-xxx\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"instanceType\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"t3a.medium\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"kernelId\"</span> <span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"pendingTime\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"2021-01-06T12:31:42Z\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"privateIp\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"172.31.xx.xx\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"ramdiskId\"</span> <span class=\"token operator\">:</span> <span class=\"token null keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"region\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"ap-northeast-1\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"version\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"2017-09-30\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>取得 Instance-Id 後，<br>\n再透過 <strong>AWS Cli</strong> 取得機器上的 Tag 資訊  </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">aws ec2 describe-tags --filter &quot;Name=resource-id,Values=${INSTANCE_ID}&quot; --region ${REGION}</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Tags\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"ResourceType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"instance\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"ResourceId\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"i-xxx\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Value\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"xxx\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Key\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ServiceName\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>        \n    <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>最後取得需要的 Tag 資訊，<br>\nmain 裡面的實作可以參考以下</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">..</span>.\n\n<span class=\"token assign-left variable\">REGION</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">curl</span> -s http://169.254.169.254/latest/dynamic/instance-identity/document <span class=\"token operator\">|</span> jq .region -r<span class=\"token variable\">`</span></span>\n<span class=\"token assign-left variable\">INSTANCE_ID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">curl</span> -s http://169.254.169.254/latest/dynamic/instance-identity/document <span class=\"token operator\">|</span> jq .instanceId -r<span class=\"token variable\">`</span></span>\n<span class=\"token assign-left variable\">TAGS</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">$(</span>aws ec2 describe-tags --filter <span class=\"token string\">\"Name=resource-id,Values=<span class=\"token variable\">${INSTANCE_ID}</span>\"</span> --region $<span class=\"token punctuation\">{</span>REGION<span class=\"token punctuation\">}</span><span class=\"token variable\">)</span></span>\"</span>\n<span class=\"token assign-left variable\">ServiceName</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token builtin class-name\">echo</span> $TAGS <span class=\"token operator\">|</span> jq -r <span class=\"token string\">'.Tags[] | select(.Key == \"ServiceName\").Value'</span><span class=\"token variable\">`</span></span>\n\naws s3 <span class=\"token function\">cp</span> s3://<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>s3 bucket name<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>/<span class=\"token variable\">$ServiceName</span>/install.sh install.sh --region <span class=\"token variable\">$REGION</span>\n<span class=\"token function\">bash</span> install.sh\n\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span></code></pre></div>\n<h2>自動擴展</h2>\n<p>這樣的 Provision 方式，<br>\n讓服務部屬的準備可以完全自動化。<br>\n也可以讓自動擴展的設計上，<br>\n直接依賴 Provision 機制自動橫向擴展。<br>\n根據現有團隊的測試，<br>\n一台 T3.Medium，<br>\n在 Windows Server 的服務可以在 15 分鐘左右完成 Provision，<br>\n在 Linux Server 的服務可以在 7 分鐘左右完成 Provision。</p>","frontmatter":{"title":"AWS 上的 Provision 實作","date":"May 08, 2021","description":"provision-implement-aws-sample"}}},"pageContext":{"slug":"/provision-implement-aws-sample/","previous":{"fields":{"slug":"/logstash-health-check/"},"frontmatter":{"title":"Logstash 的服務健康檢查機制"}},"next":null}},"staticQueryHashes":["3000541721","3274528899"]}